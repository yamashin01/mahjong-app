# イベントごとの対局ルール設定機能の実装

## 概要

イベントごとに独自の対局ルールを設定できる機能を実装しました。これにより、グループのデフォルトルールとは異なるルールでイベントを運営できるようになります。

## 実装内容

### 1. データベース変更

**新規マイグレーション**: `supabase/migrations/020_add_rules_to_events.sql`

eventsテーブルに以下のカラムを追加:
- `game_type` - 対局種別（東風戦/東南戦）
- `start_points` - 開始持ち点
- `return_points` - 返し持ち点
- `uma_first`, `uma_second`, `uma_third`, `uma_fourth` - ウマ（順位点）
- `oka_enabled` - オカ有効フラグ
- `rate` - レート
- `tobi_prize` - トビ賞
- `yakuman_prize` - 役満賞
- `top_prize` - トップ賞

すべてのカラムはNULL許可で、NULLの場合はグループのデフォルトルールが使用されます。

### 2. 型定義

**新規ファイル**: `src/types/event-rules.ts`

以下の型を定義:
- `EventRules` - イベントルール設定の型
- `EventWithRules` - イベント詳細（ルール含む）
- `CreateEventFormData` - イベント作成時のフォームデータ

### 3. サーバーアクション

**更新ファイル**: `src/app/actions/events.ts`

#### 機能追加:
- `createEvent`: イベント作成時にカスタムルールを保存
- `updateEventRules`: イベントルールの更新（新規追加）

### 4. UIコンポーネント

**新規ファイル**: `src/components/event-rules-form.tsx`

イベントルール設定用のフォームコンポーネント:
- カスタムルール有効/無効の切り替え
- グループルールのプレビュー表示
- すべてのルールパラメータの入力フィールド
- 作成モード/編集モードのサポート

### 5. ページ更新

#### イベント作成ページ
**更新ファイル**: `src/app/groups/[id]/events/new/page.tsx`

- EventRulesFormコンポーネントを統合
- グループルールの取得とフォームへの渡し
- ルール設定セクションの追加

#### イベント設定ページ（新規）
**新規ファイル**: `src/app/groups/[id]/events/[eventId]/settings/page.tsx`

- イベントルールの編集専用ページ
- 管理者のみアクセス可能
- 既存のルール設定を読み込んで編集可能

#### イベント詳細ページ
**更新ファイル**: `src/app/groups/[id]/events/[eventId]/page.tsx`

- 「ルール設定」ボタンの追加（管理者のみ表示）

### 6. 対局作成ロジック

**更新ファイル**: `src/app/actions/games.ts`

対局作成時にイベントルールを適用:
- イベントIDが指定されている場合、イベントのカスタムルールを取得
- カスタムルールが設定されている項目のみグループルールを上書き
- NULLの項目はグループルールを使用

### 7. ルール表示コンポーネント（新規）

**新規ファイル**: `src/components/event-rules-display.tsx`

イベント詳細ページでルールを表示するコンポーネント:
- イベントのカスタムルールとグループのデフォルトルールを比較
- カスタムルールが設定されている場合はバッジで表示
- 基本設定、ウマ・レート、賞金設定を見やすくグリッド表示
- 賞金が設定されていない場合は非表示

**更新ファイル**: `src/app/groups/[id]/events/[eventId]/page.tsx`

イベント詳細ページにルール表示を統合:
- グループルールの取得を追加
- イベントルールを抽出
- EventRulesDisplayコンポーネントを対局記録セクションの下に配置

## 使用方法

### イベント作成時のルール設定

1. グループページで「新しいイベントを作成」をクリック
2. イベント情報を入力
3. 「ルール設定」セクションで「このイベント専用のルールを設定する」をチェック
4. 必要に応じてルールパラメータを変更
5. 「イベントを作成」をクリック

### 既存イベントのルール編集

1. イベント詳細ページを開く
2. 管理者の場合、「ルール設定」ボタンが表示される
3. 「ルール設定」をクリック
4. ルールを編集
5. 「保存」をクリック

### 対局記録時の動作

- イベントに紐付けて対局を記録する場合、自動的にイベントのルール設定が適用されます
- イベントにカスタムルールが設定されていない場合は、グループのデフォルトルールが使用されます
- 既に記録された対局のルールは遡って変更されません

## 技術的な詳細

### ルールの優先順位

1. イベントのカスタムルール（NULL以外の値）
2. グループのデフォルトルール

### データフロー

```
イベント作成/編集
  ↓
EventRulesForm（フォーム入力）
  ↓
createEvent/updateEventRules（サーバーアクション）
  ↓
eventsテーブル（ルール保存）

対局記録
  ↓
createGame（サーバーアクション）
  ↓
イベントルール取得
  ↓
グループルールとマージ
  ↓
点数計算・記録
```

### 型安全性

- TypeScriptの型定義により、ルールの型安全性を保証
- NULL許可により、オプショナルなカスタマイズをサポート
- スプレッド演算子による安全なオブジェクトマージ

## テスト項目

### 基本機能
- [ ] イベント作成時にカスタムルールを設定できる
- [ ] カスタムルールを無効にするとグループルールが表示される
- [ ] イベント設定ページでルールを編集できる
- [ ] 対局記録時にイベントルールが適用される

### エッジケース
- [ ] カスタムルールの一部だけを設定した場合、他の項目はグループルールが使用される
- [ ] イベントルールを変更しても既存の対局記録に影響しない
- [ ] イベントIDなしの対局はグループルールが使用される

### 権限
- [ ] 管理者のみがルール設定ページにアクセスできる
- [ ] 一般メンバーには「ルール設定」ボタンが表示されない

## マイグレーション手順

ローカル環境:
```bash
pnpm supabase db reset
```

本番環境:
```bash
pnpm supabase db push
```

## トラブルシューティング

### イベント作成時のエラー: "Could not find the 'game_type' column"

**原因**: データベースマイグレーションが適用されていない

**解決方法**:
```bash
# ローカル環境
pnpm supabase db reset

# または
pnpm supabase migration up
```

**注意**: Docker Desktopが起動していることを確認してください

### ルール設定の保存後に画面遷移しない

**原因**: `updateEventRules`アクションで`redirect()`が呼ばれていなかった

**解決済み**: `redirect()`を追加し、保存後はイベント詳細ページに自動遷移するようになりました

## 今後の拡張可能性

- イベントテンプレート機能（よく使うルール設定を保存）
- ルール設定のプリセット（一般的な大会ルールなど）
- イベントごとの賞金・賞品設定の詳細化
- ルール設定の履歴管理
