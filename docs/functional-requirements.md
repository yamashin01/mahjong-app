# 機能要件仕様書

## 1. プロジェクト概要

### 1.1 目的
友人同士のカジュアルな麻雀および定期的な麻雀サークルにおけるスコア記録・管理を効率化し、参加者全員が成績を共有できるアプリケーションを提供する。

### 1.2 主要ユーザー
- グループ管理者: グループ作成・設定・メンバー管理を行うユーザー
- メンバー: 麻雀に参加し、スコアの入力・管理および成績閲覧を行うユーザー

### 1.3 利用シーン
- 友人同士のカジュアルな麻雀の集まり
- 定期的な麻雀サークルや固定メンバーでの対局

### 1.4 技術スタック
- フロントエンド: Next.js 15 (App Router) + React 19 + TypeScript
- スタイリング: Tailwind CSS + shadcn/ui
- バックエンド/DB: Supabase (PostgreSQL)
- 認証: Supabase Auth (Google OAuth)
- デプロイ: Vercel
- 形態: PWA（Progressive Web App）
- フォーム管理: React Hook Form + Zod

### 1.5 デザイン方針
- シンプルで機能的
- 直感的な操作フロー
- レスポンシブデザイン（モバイルファースト）
- 初心者でも使いやすいUI/UX

## 2. 機能要件

### 2.1 認証機能

#### 2.1.1 ユーザー登録・ログイン
- **FR-AUTH-001**: Google OAuth によるログイン機能
  - Google アカウントでワンクリックログイン
  - Supabase Auth を利用
  - 初回ログイン時にユーザープロファイル自動作成

- **FR-AUTH-002**: ログアウト機能
  - ヘッダーまたは設定メニューからログアウト可能

- **FR-AUTH-003**: 認証状態の永続化
  - リロード後もログイン状態を維持
  - セッション管理

#### 2.1.2 ユーザープロファイル
- **FR-AUTH-004**: プロファイル情報
  - 表示名（Google アカウントから自動取得）
  - プロフィール画像（Google アカウントから自動取得）
  - ユーザーID（自動生成）

### 2.2 グループ管理機能

#### 2.2.1 グループ作成
- **FR-GROUP-001**: グループ新規作成
  - ログイン済みユーザーなら誰でも作成可能
  - グループ名の設定（必須）
  - 作成者が自動的にグループ管理者となる

- **FR-GROUP-002**: グループルール設定
  - 基本設定:
    - 東風戦 / 東南戦の選択
    - 開始点数（例: 25000点）
    - 返し点（例: 30000点）
    - ウマ（例: 5-10、10-20など）
    - オカの有無
  - レート設定:
    - 点棒1000点あたりのポイント（1.0なら1000点あたり100pt）
  - 拡張設定:
    - トビ賞の有無とポイント
    - 役満祝儀の有無とポイント
    - トップ賞の有無とポイント
    - ヤキトリ賞の有無とポイント（一度も和了しなかった場合のペナルティ）

- **FR-GROUP-003**: グループルールの表示
  - グループ詳細画面でルールを常時確認可能

#### 2.2.2 メンバー管理
- **FR-GROUP-004**: 招待リンク生成
  - グループ管理者が招待リンクを生成
  - リンクをコピーして共有可能
  - リンクにアクセスしたユーザーがグループに参加

- **FR-GROUP-005**: メンバー一覧表示
  - グループに所属するメンバーの一覧
  - 各メンバーの名前とプロフィール画像を表示

- **FR-GROUP-006**: メンバー削除
  - グループ管理者がメンバーを削除可能
  - 削除確認ダイアログを表示

#### 2.2.3 ゲストプレイヤー管理
- **FR-GUEST-001**: ゲストプレイヤー作成
  - グループ管理者がアプリ未登録のプレイヤーをゲストとして追加可能
  - ゲストプレイヤー名の設定（必須）
  - 対局記録時にゲストプレイヤーを選択可能

- **FR-GUEST-002**: ゲストプレイヤー編集
  - グループ管理者がゲストプレイヤー名を編集可能

- **FR-GUEST-003**: ゲストプレイヤー削除
  - グループ管理者がゲストプレイヤーを削除可能
  - 削除確認ダイアログを表示

- **FR-GUEST-004**: ゲストプレイヤー一覧表示
  - グループメンバー全員がゲストプレイヤー一覧を閲覧可能
  - ゲストプレイヤー名を表示

#### 2.2.4 グループ一覧
- **FR-GROUP-007**: 所属グループ一覧表示
  - ログインユーザーが所属する全グループを表示
  - グループ名、メンバー数、最終更新日時を表示
  - タップ/クリックでグループ詳細へ遷移

### 2.3 イベント管理機能

#### 2.3.1 イベント作成
- **FR-EVENT-001**: イベント新規作成
  - グループメンバーなら誰でも作成可能
  - イベント名の設定（必須）
  - イベント説明の設定（任意）
  - 開催日の設定（必須、デフォルトは当日）
  - 作成時のステータスは「進行中」

- **FR-EVENT-002**: イベントルール設定
  - カスタムルールの設定（任意）:
    - 東風戦 / 東南戦の選択
    - 開始点数
    - 返し点
    - ウマ
    - オカの有無
    - レート
    - 拡張設定（トビ賞、役満祝儀、トップ賞、ヤキトリ賞）
  - 未設定の場合はグループルールを継承

#### 2.3.2 イベント管理
- **FR-EVENT-003**: イベント一覧表示
  - グループ詳細画面にイベント一覧を表示
  - 進行中イベントと完了済みイベントを分けて表示
  - イベント名、開催日、ステータスを表示

- **FR-EVENT-004**: イベント詳細表示
  - イベント情報（名前、説明、開催日、ステータス、適用ルール）
  - イベント内の対局履歴一覧
  - イベント成績ランキング（進行中は途中経過、完了時は最終結果）
  - プレイヤー別詳細成績（対局数、合計ポイント、順位分布）

- **FR-EVENT-005**: イベント編集
  - グループメンバーなら誰でも編集可能
  - イベント情報とルール設定の変更
  - ステータス変更（進行中⇔完了）

- **FR-EVENT-006**: イベント削除
  - グループメンバーなら誰でも削除可能
  - 削除確認ダイアログを表示
  - イベントに紐付く対局記録は削除されない（イベント紐付けが解除される）

#### 2.3.3 イベント成績集計
- **FR-EVENT-007**: イベント途中経過表示
  - 進行中イベントの暫定ランキング
  - 各プレイヤーの合計ポイントと順位

- **FR-EVENT-008**: イベント最終結果表示
  - 完了したイベントの確定ランキング
  - 各プレイヤーの最終順位と合計ポイント
  - プレイヤー別詳細成績（1-2-3-4位の回数など）

### 2.4 対局記録機能

#### 2.4.1 対局記録（半荘記録）
- **FR-SCORE-001**: 新規対局の作成
  - グループメンバーなら誰でも実行可能
  - 「新しい対局を記録」ボタンから開始
  - イベントへの紐付け（任意）

- **FR-SCORE-002**: 参加プレイヤー選択
  - グループメンバー + ゲストプレイヤーから4名を選択
  - 座席（東南西北）の割り当て

- **FR-SCORE-003**: 対局設定
  - 東風戦 / 東南戦の選択（イベントルール > グループルールをデフォルト表示）
  - 対局日時の設定（デフォルトは現在時刻）
  - カスタムルールの設定（任意、NULLの場合はイベントルール > グループルールを継承）

- **FR-SCORE-004**: 最終持ち点の入力
  - 各プレイヤーの最終持ち点を入力
  - 数値キーボードで入力しやすく

- **FR-SCORE-005**: トビ・祝儀の入力
  - トビの有無を選択（該当プレイヤーを指定）
  - 役満祝儀の有無と個数を入力

- **FR-SCORE-006**: 自動計算
  - 各プレイヤーの収支を自動計算
    - 素点計算（最終持ち点 - 返し点）
    - ウマの計算（順位に応じて、同点時は均等分割）
    - オカの計算（1位のみ、同点時は均等分割）
    - トビ賞・役満祝儀・ヤキトリ賞の加算
    - レート適用後のポイント計算
  - 順位の自動判定（同点処理を含む）

- **FR-SCORE-007**: エラーチェック
  - 合計点数の検証（4人の合計が正しいか）
  - エラーがある場合は警告を表示
  - 入力ミスの防止

- **FR-SCORE-008**: 確認と保存
  - 計算結果の確認画面
  - 保存ボタンで確定
  - 保存後は日次集計画面に遷移

#### 2.4.2 対局記録の修正・削除
- **FR-SCORE-009**: 記録の編集
  - グループメンバーなら誰でも保存済み対局を編集可能
  - 編集画面で各項目を修正
  - 再計算と保存

- **FR-SCORE-010**: 記録の削除
  - グループメンバーなら誰でも保存済み対局を削除可能
  - 削除確認ダイアログを表示
  - イベント成績は自動的に再計算される

### 2.5 集計・表示機能

#### 2.5.1 対局詳細画面
- **FR-VIEW-001**: 対局の詳細情報表示
  - 日時
  - 東風戦/東南戦
  - 参加プレイヤーと座席
  - 各プレイヤーの最終持ち点、素点、ウマ、オカ、ポイント、順位
  - トビ・役満祝儀の有無
  - 適用されたルール
  - 紐付けられたイベント（ある場合）

- **FR-VIEW-002**: 対局詳細からの編集・削除
  - グループメンバーなら編集・削除ボタンを表示

#### 2.5.2 対局履歴表示
- **FR-VIEW-003**: グループの対局履歴一覧
  - グループ内の全対局を時系列で表示
  - 各対局の日時、参加メンバー、結果を表示
  - イベント紐付けがある場合はイベント名も表示

- **FR-VIEW-004**: 最近の対局表示
  - グループ詳細画面に最新5件の対局を表示
  - タップ/クリックで対局詳細へ遷移

### 2.6 ユーザープロファイル機能

#### 2.6.1 プロファイル表示と編集
- **FR-PROFILE-001**: プロファイル情報表示
  - 表示名
  - プロフィール画像（アバター）
  - メールアドレス

- **FR-PROFILE-002**: アバター画像のアップロード
  - 画像ファイルの選択とアップロード
  - Supabase Storageにアバター画像を保存
  - 画像プレビュー機能

- **FR-PROFILE-003**: 表示名の編集
  - 表示名の変更機能
  - 変更内容の保存

### 2.7 画面構成

#### 2.7.1 共通要素
- **FR-UI-001**: ヘッダー
  - アプリ名/ロゴ
  - ユーザーアイコン（タップでメニュー表示）
  - 戻るボタン（必要な画面のみ）

- **FR-UI-002**: ナビゲーション
  - ホーム
  - 所属グループ一覧
  - ユーザー設定

#### 2.7.2 画面一覧
1. **ログイン画面** (`/login`)
   - Google ログインボタン

2. **ホーム画面** (`/`)
   - 所属グループ一覧
   - 「新しいグループを作成」ボタン
   - 「招待コードで参加」ボタン

3. **グループ作成画面** (`/groups/new`)
   - グループ名・説明入力
   - ルール設定フォーム
   - 作成ボタン

4. **グループ参加画面** (`/groups/join`)
   - 招待コード入力フォーム
   - 参加ボタン

5. **グループ詳細画面** (`/groups/[id]`)
   - グループ名・説明とルール表示
   - メンバー一覧
   - ゲストプレイヤー一覧
   - 招待コード表示・コピーボタン
   - イベント一覧（進行中・完了済み）
   - 「新規イベント作成」ボタン
   - 最近の対局履歴（最新5件）
   - 「新しい対局を記録」ボタン
   - グループ設定ボタン（管理者のみ）

6. **グループ設定画面** (`/groups/[id]/settings`)
   - グループ名・説明編集
   - ルール設定編集
   - メンバー管理（削除）
   - ゲストプレイヤー管理（追加・編集・削除）
   - グループ削除（管理者のみ）

7. **イベント作成画面** (`/groups/[id]/events/new`)
   - イベント名・説明入力
   - 開催日選択
   - カスタムルール設定（任意）
   - 作成ボタン

8. **イベント詳細画面** (`/groups/[id]/events/[eventId]`)
   - イベント情報表示
   - 適用ルール表示
   - 成績ランキング（進行中は途中経過、完了時は最終結果）
   - イベント内対局履歴
   - 「対局を追加」ボタン
   - イベント設定ボタン

9. **イベント設定画面** (`/groups/[id]/events/[eventId]/settings`)
   - イベント情報編集
   - カスタムルール編集
   - ステータス変更（進行中⇔完了）
   - イベント削除

10. **対局記録画面** (`/groups/[id]/games/new`)
    - プレイヤー選択（メンバー + ゲスト）
    - 座席割り当て
    - イベント選択（任意）
    - 対局設定（東風/東南、日時）
    - 最終持ち点入力
    - トビ・役満祝儀入力
    - カスタムルール設定（任意）
    - 計算結果プレビュー
    - 保存ボタン

11. **対局詳細画面** (`/groups/[id]/games/[gameId]`)
    - 対局情報表示（日時、形式、イベント）
    - 参加プレイヤーと結果詳細
    - 適用ルール表示
    - 編集・削除ボタン

12. **プロフィール画面** (`/profile`)
    - プロフィール情報表示・編集
    - アバター画像アップロード
    - 表示名編集
    - ログアウトボタン

## 3. 非機能要件

### 3.1 セキュリティ
- 全通信はHTTPS で暗号化
- Supabase Row Level Security (RLS) でデータアクセス制御
- グループデータは所属メンバーのみアクセス可能

### 3.2 互換性
- モダンブラウザの最新版に対応（Chrome, Safari, Firefox, Edge）
- iOS, Android, Windows, macOS で動作

## 4. データ要件

### 4.1 主要エンティティ
- **Profiles**: ユーザー情報（表示名、アバター画像URL）
- **Groups**: グループ情報（名前、説明、招待コード）
- **GroupMembers**: グループとユーザーの関連（役割: admin/member）
- **GroupRules**: グループルール設定
- **GuestPlayers**: ゲストプレイヤー情報（アプリ未登録プレイヤー）
- **Events**: イベント情報（名前、説明、開催日、ステータス、カスタムルール）
- **Games**: 対局記録（日時、形式、イベント紐付け）
- **GameResults**: 各プレイヤーの対局結果（素点、ウマ、オカ、ポイント、順位）
- **Storage (avatars bucket)**: プロフィール画像の保存先

### 4.2 データ保持期間
- 全データ: 無期限保持（ユーザーまたはグループ削除まで）

## 5. 用語集

| 用語 | 説明 |
|------|------|
| 対局 / 半荘 | 麻雀の1回の対局単位（東風戦または東南戦） |
| 東風戦 | 東場のみで終了する短い対局形式 |
| 東南戦 | 東場と南場で構成される標準的な対局形式 |
| イベント | 複数の対局をまとめて管理する単位（月例大会など） |
| ゲストプレイヤー | アプリに登録していないプレイヤー（グループ管理者が追加） |
| ウマ | 順位に応じたボーナスポイント（同点時は均等分割） |
| オカ | 返し点と開始点の差分による調整（1位のみに配分） |
| トビ | 持ち点が0点未満になること |
| トビ賞 | トビしたプレイヤーへのペナルティポイント |
| 役満祝儀 | 役満を和了した際のボーナスポイント |
| トップ賞 | 1位のプレイヤーへのボーナスポイント |
| ヤキトリ賞 | 一度も和了しなかったプレイヤーへのペナルティポイント |
| レート | 点棒をポイントに換算する際の倍率 |
| 素点 (raw_score) | 最終持ち点 - 返し点 |
| 返し点 | 収支計算の基準点（通常30000点または25000点） |
| 開始点数 | 対局開始時の各プレイヤーの持ち点（通常25000点） |
| ポイント (point_amount) | 最終的な収支ポイント（レート適用後） |
