# 機能設計書 (Specification)

## 目次

1. [概要](#1-概要)
2. [機能一覧と実装状況](#2-機能一覧と実装状況)
3. [画面仕様](#3-画面仕様)
4. [ビジネスロジック仕様](#4-ビジネスロジック仕様)
5. [非機能要件](#5-非機能要件)

## 1. 概要

本ドキュメントは、麻雀スコア管理アプリケーションの基本設計を定義し、実装された機能の仕様を明確化することを目的とする。

## 2. 機能一覧と実装状況

### 2.1 認証機能
- FR-AUTH-001: Google OAuth ログイン機能
- FR-AUTH-002: ログアウト機能
- FR-AUTH-003: 認証状態の永続化

### 2.2 グループ管理機能
- FR-GROUP-001: グループ新規作成
- FR-GROUP-002: グループルール設定
- FR-GROUP-003: グループルールの表示
- FR-GROUP-004: 招待リンク生成
- FR-GROUP-005: メンバー一覧表示
- FR-GROUP-006: グループ削除（管理者のみ）
- FR-GROUP-007: 所属グループ一覧表示

### 2.3 ゲストプレイヤー機能
- FR-GUEST-001: ゲストプレイヤー登録（管理者のみ）
- FR-GUEST-002: ゲストプレイヤー編集（管理者のみ）
- FR-GUEST-003: ゲストプレイヤー削除（管理者のみ）
- FR-GUEST-004: ゲストプレイヤー一覧表示（メンバー全員）

### 2.4 イベント機能
- FR-EVENT-001: イベント作成（全メンバー）
- FR-EVENT-002: イベントルール設定
- FR-EVENT-003: イベント詳細表示
- FR-EVENT-004: イベント編集（全メンバー）
- FR-EVENT-005: イベント削除（全メンバー）
- FR-EVENT-006: イベント一覧表示

### 2.5 対局記録機能
- FR-SCORE-001: 新規対局の作成
- FR-SCORE-002: 参加プレイヤー選択（通常ユーザー + ゲストプレイヤー）
- FR-SCORE-003: 対局設定（東風/東南）
- FR-SCORE-004: 最終持ち点の入力
- FR-SCORE-005: トビ・祝儀の入力
- FR-SCORE-006: 自動計算（素点、ウマオカ、ポイント）
- FR-SCORE-007: エラーチェック（合計点数検証）
- FR-SCORE-008: 確認と保存
- FR-SCORE-009: 記録の編集
- FR-SCORE-010: 記録の削除

### 2.6 集計・表示機能
- FR-VIEW-001: イベント内の対局一覧表示
- FR-VIEW-002: イベントランキング表示
- FR-VIEW-003: 対局詳細情報表示
- FR-VIEW-004: 対局詳細からの編集・削除

---

## 3. 画面仕様

### 3.1 画面遷移図

```
[ログイン画面]
    ↓ Google認証
[ホーム画面] ←→ [プロフィール画面]
    ↓
[グループ一覧画面]
    ↓
[グループ作成画面] → [グループ詳細画面]
    ↓                      ↓
[グループ設定画面]        [イベント作成画面]
                          ↓
                     [イベント詳細画面]
                          ↓
                     [イベント設定画面]
                          ↓
                     [対局記録画面]
                          ↓
                     [対局詳細画面]
```

### 3.2 画面別詳細仕様

#### 3.2.1 ログイン画面
- URL: `/login`
- コンポーネント: `src/app/login/page.tsx`
- アクセス権限: 未認証ユーザーのみ
- 表示内容:
  - アプリケーション名・ロゴ
  - Googleログインボタン
- ユーザーアクション:
  - Googleログインボタンクリック → Google OAuth フロー → ホーム画面へリダイレクト

#### 3.2.2 ホーム画面
- URL: `/`
- コンポーネント: `src/app/page.tsx`
- アクセス権限: 認証済みユーザー
- 表示内容:
  - 所属グループ一覧（カード形式）
  - プロフィールへのリンク
  - 「新規作成」ボタン
- ユーザーアクション:
  - グループ一覧表示ボタンクリック → グループ一覧画面へ遷移
  - 新規作成ボタンクリック → グループ作成画面へ遷移
  - 招待コードで参加ボタンクリック → グループ参加画面へ遷移

#### 3.2.3 グループ作成画面
- URL: `/groups/new`
- コンポーネント: `src/app/groups/new/page.tsx`
- アクセス権限: 認証済みユーザー
- 入力フォーム:
  - グループ名（必須）
  - グループ説明（任意）
- ユーザーアクション:
  - 作成ボタンクリック → グループ作成 → グループ詳細画面へ遷移
  - キャンセルボタンクリック → トップ画面へ戻る

#### 3.2.4 グループ詳細画面
- URL: `/groups/[id]`
- コンポーネント: `src/app/groups/[id]/page.tsx`
- アクセス権限: グループメンバーのみ
- 表示内容:
  - グループ情報セクション:
    - グループ名
    - グループ説明
    - 招待リンク生成・コピーボタン
    - グループ設定ボタン（管理者のみ表示）
  - メンバー・ゲストメンバー一覧セクション:
    - メンバーの名前とアバター
    - 参加日時
    - ゲストメンバー追加ボタン（管理者のみ）
    - ゲストメンバー編集・削除ボタン（管理者のみ）
  - イベントセクション:
    - 進行中イベント一覧
    - 完了済みイベント一覧
    - 新規イベント作成ボタン
- ユーザーアクション:
  - 招待リンクコピー → クリップボードにコピー
  - グループ設定 → グループ設定画面へ遷移
  - ゲストプレイヤー追加 → ゲストプレイヤーフォーム表示
  - イベントカードクリック → イベント詳細画面へ遷移
  - 新規イベント作成 → イベント作成画面へ遷移
  - 削除ボタンクリック → 確認ダイアログ → グループ削除 → グループ一覧画面へ遷移

#### 3.2.5 グループルール設定画面
- URL: `/groups/[id]/settings`
- コンポーネント: `src/app/groups/[id]/settings/page.tsx`
- アクセス権限: グループ管理者のみ
- 表示内容:
  - グループ情報編集フォーム（グループ名、説明）
  - ルール設定編集フォーム
  - 危険な操作エリア（グループ削除）
- ユーザーアクション:
  - 設定を保存ボタンクリック → グループ情報更新 → グループ詳細画面へ戻る

#### 3.2.6 グループ参加画面
- URL: `/groups/join?code=[inviteCode]`
- コンポーネント: `src/app/groups/join/page.tsx`
- アクセス権限: 認証済みユーザー
- 表示内容:
  - 招待コード
- ユーザーアクション:
  - 招待コードを入力 → グループに参加ボタンクリック → グループ詳細画面へ遷移
  - キャンセル → ホーム画面へ戻る

#### 3.2.7 イベント作成画面
- URL: `/groups/[id]/events/new`
- コンポーネント: `src/app/groups/[id]/events/new/page.tsx`
- アクセス権限: グループメンバー
- 入力フォーム:
  - イベント名（必須）
  - イベント説明（任意）
  - 開催日（必須）
  - ルール設定（任意、NULLの場合はグループルール継承）:
    - 東風戦/東南戦選択
    - 開始点数
    - 返し点
    - ウマ
    - オカ有効/無効
    - レート
    - 各種追加ポイント設定（トビ賞、役満祝儀、トップ賞、ヤキトリ賞）
- ユーザーアクション:
  - イベントを作成ボタンクリック → イベント作成 → イベント詳細画面へ遷移
  - キャンセル → グループ詳細画面へ戻る

#### 3.2.8 イベント詳細画面
- URL: `/groups/[id]/events/[eventId]`
- コンポーネント: `src/app/groups/[id]/events/[eventId]/page.tsx`
- アクセス権限: グループメンバー
- 表示内容:
  - イベント情報セクション:
    - イベント名
    - イベント説明
    - 開催日
    - ステータス（進行中/完了）
    - 適用ルール表示
    - イベント設定ボタン（全メンバー）
  - 対局記録セクション:
    - イベント内の全対局リスト
    - 各対局の開始時刻、参加プレイヤー、結果
  - 成績ランキングセクション（イベント完了時のみ表示）:
    - イベント内の成績ランキング（`getEventRankings()` で集計）
    - 総合ポイント収支
    - 対局数
    - 順位分布（1位・2位・3位・4位の回数）
    - 同点の場合は同順位として扱う
- ユーザーアクション:
  - 対局記録を追加ボタンクリック → 対局記録画面へ遷移（イベントID付き）
  - イベント設定 → イベント設定画面へ遷移
  - 対局カードクリック → 対局詳細画面へ遷移
  - 削除ボタンクリック → 確認ダイアログ → イベント削除 → グループ詳細画面へ遷移

#### 3.2.9 イベント設定画面
- URL: `/groups/[id]/events/[eventId]/settings`
- コンポーネント: `src/app/groups/[id]/events/[eventId]/settings/page.tsx`
- アクセス権限: グループメンバー全員
- 表示内容:
  - イベント情報編集フォーム
  - ルール設定編集フォーム
  - ステータス変更（進行中/完了）
  - 危険な操作エリア（イベント削除）
- ユーザーアクション:
  - 更新ボタンクリック → イベント情報更新 → イベント詳細画面へ戻る

#### 3.2.10 対局記録画面
- URL: `/groups/[id]/games/new?eventId=[eventId]` (eventIdは任意)
- コンポーネント: `src/app/groups/[id]/games/new/page.tsx`
- アクセス権限: グループメンバー
- 入力フォーム:
  - プレイヤー選択セクション:
    - 東家、南家、西家、北家の4名を選択
    - 選択肢: グループメンバー + ゲストプレイヤー
  - 対局設定セクション:
    - 東風戦/東南戦選択（デフォルト: イベントルール > グループルール）
    - 対局日時（デフォルト: 現在時刻）
  - 得点入力セクション:
    - 各プレイヤーの最終持ち点入力
    - 数値キーボード対応
  - 特殊状況セクション:
    - トビプレイヤー選択（任意）
    - 役満回数入力（任意）
  - カスタムルールセクション（任意、展開式）:
    - 開始点数
    - 返し点
    - ウマ
    - レート
    - ※NULLの場合はイベントルール > グループルールを継承
  - 計算結果プレビューセクション:
    - 各プレイヤーの素点
    - ウマオカ込みスコア
    - ポイント
    - 順位
    - 合計点数の検証結果
- ユーザーアクション:
  - 保存ボタンクリック → バリデーション → 対局保存 → 対局詳細画面へ遷移
  - キャンセル → 前画面へ戻る

#### 3.2.11 対局詳細画面
- URL: `/groups/[id]/games/[gameId]`
- コンポーネント: `src/app/groups/[id]/games/[gameId]/page.tsx`
- アクセス権限: グループメンバー
- 表示内容:
  - 対局情報セクション:
    - 対局日時
    - 東風戦/東南戦
    - イベント名（イベントに紐づく場合）
    - 適用ルール表示
  - 結果テーブル:
    - プレイヤー名（座席）
    - 最終持ち点
    - 素点
    - ウマ
    - 順位
    - 総合スコア
    - ポイント
  - 特殊情報:
    - トビプレイヤー
    - 役満回数
  - 操作ボタン（メンバー全員表示）:
    - 編集ボタン
    - 削除ボタン
- ユーザーアクション:
  - 編集ボタンクリック → 対局記録画面へ遷移（編集モード）
  - 削除ボタンクリック → 確認ダイアログ → 対局削除 → 前画面へ戻る

#### 3.2.12 プロフィール画面
- URL: `/profile`
- コンポーネント: `src/app/profile/page.tsx`
- アクセス権限: 認証済みユーザー
- 表示内容:
  - ユーザー情報:
    - 表示名（Google アカウントから自動取得）
    - メールアドレス
    - プロフィール画像
  - ログアウトボタン
- ユーザーアクション:
  - ログアウトボタンクリック → ログアウト → ログイン画面へ遷移

---

## 4. ビジネスロジック仕様

### 4.1 スコア計算ロジック

#### 4.1.1 基本計算式

```
# 1. 素点計算
素点 (raw_score) = 最終持ち点 - 返し点

# 2. ウマとオカの計算
ウマ (uma) = 順位に応じたウマ値（同点の場合は該当順位のウマを均等分割）
  - 1位: uma_first
  - 2位: uma_second
  - 3位: uma_third
  - 4位: uma_fourth

オカ (oka) = オカ有効時のみ、1位のみに配分
  - オカ値 = (返し点 - 開始点数) × 4
  - 例: 開始点数25000、返し点30000の場合、オカ値 = 20000
  - 1位が複数の場合は均等分割

# 3. ポイント計算
トビ賞 = トビした場合のペナルティ/ボーナス
役満祝儀 = 役満回数 × 役満祝儀額
ヤキトリ賞 = 一度も和了しなかった場合のペナルティ

最終ポイント (point_amount) = (素点 + ウマ + オカ + トビ賞 + 役満祝儀 + ヤキトリ賞) ÷ 10 × レート

※ game_results テーブルには raw_score, uma, oka が個別に保存される
```

#### 4.1.2 ルール取得ロジック

対局のルール適用は以下の優先順位で決定される

```
1. 対局のカスタムルール (games.custom_*)
   ↓ NULLの場合
2. イベントルール (events.*)
   ↓ NULLの場合
3. グループデフォルトルール (group_rules.*)
```

各ルール項目ごとに個別に適用されるため、一部のみカスタマイズすることが可能。

例:
- カスタムルールで`custom_rate`のみ設定
- `custom_start_points`は NULL
- → レートのみカスタム値を使用、開始点数はイベント/グループルールを使用

### 4.2 バリデーションルール

#### 4.2.1 対局記録時のバリデーション

必須チェック:
- プレイヤー4名が選択されているか
- 4人の合計最終持ち点が正しいか
  - 東風戦/東南戦に応じた合計点数
  - 通常: 開始点数 × 4 = 合計点数
  - 例: 25000点スタート → 合計100000点
- 座席の重複がないか
- プレイヤーの重複がないか（通常ユーザーとゲストプレイヤーを含む）

任意チェック:
- トビプレイヤーが選択されている場合、その持ち点が0点未満か

エラー表示:
- バリデーションエラーは各入力フィールドの下に表示
- 全体エラーはフォーム上部に表示

#### 4.2.2 ゲストプレイヤーのバリデーション

必須チェック:
- 名前が入力されているか
- 名前が空白のみでないか（`trim()`後にチェック）

任意チェック:
- グループ内での名前重複（警告のみ、保存は可能）

#### 4.2.3 イベントのバリデーション

必須チェック:
- イベント名が入力されているか
- 開催日が選択されているか

任意チェック:
- ルール設定値が妥当な範囲内か（例: ウマが負の値でないか）

### 4.3 権限管理

#### 4.3.1 ロール定義

| ロール | 説明 | 付与タイミング |
|-------|------|--------------|
| `admin` | グループ管理者 | グループ作成時に自動付与 |
| `member` | 一般メンバー | 招待リンク経由で参加時に付与 |

#### 4.3.2 権限マトリックス

| 機能 | admin | member |
|-----|-------|--------|
| グループ閲覧 | ✅ | ✅ |
| グループ設定変更 | ✅ | ❌ |
| グループ削除 | ✅ | ❌ |
| メンバー一覧閲覧 | ✅ | ✅ |
| メンバー削除 | ✅ | ❌ |
| ゲストプレイヤー閲覧 | ✅ | ✅ |
| ゲストプレイヤー作成 | ✅ | ❌ |
| ゲストプレイヤー編集 | ✅ | ❌ |
| ゲストプレイヤー削除 | ✅ | ❌ |
| イベント閲覧 | ✅ | ✅ |
| イベント作成 | ✅ | ✅ |
| イベント編集 | ✅ | ✅ |
| イベント削除 | ✅ | ✅ |
| 対局記録作成 | ✅ | ✅ |
| 対局記録編集 | ✅ | ✅ |
| 対局記録削除 | ✅ | ✅ |
| 成績閲覧 | ✅ | ✅ |

#### 4.3.3 RLS (Row Level Security) 概要

データベースレベルでの権限制御はSupabaseのRLSポリシーで実装。

主要ポリシー:
- `groups`: グループメンバーのみ閲覧可能
- `group_members`: グループメンバーのみ閲覧可能、管理者のみ更新・削除
- `guest_players`: グループメンバー閲覧、管理者のみ作成・更新・削除
- `events`: グループメンバーのみ閲覧・作成・更新・削除
- `games`: グループメンバーのみ閲覧・作成・更新・削除
- `game_results`: グループメンバーのみ閲覧・作成・更新・削除

詳細は[データベース設計書](./database.md)を参照。

## 5. 非機能要件

### 5.1 セキュリティ

#### 5.1.1 認証・認可
- Google OAuth経由のSupabase Auth使用
- JWT トークンによるセッション管理
- RLS（Row Level Security）によるデータアクセス制御

#### 5.1.2 データ保護
- HTTPS通信の強制
- XSS対策: Reactの自動エスケープ機能
- CSRF対策: Supabase Authのトークン検証
- 入力検証: クライアント（Zod）+ サーバー（PostgreSQL制約 + RLS）

#### 5.1.3 プライバシー
- 個人情報の最小限収集（Google アカウントの名前・メール・画像のみ）
- グループベースのアクセス制御
- 招待制によるグループ参加

### 5.2 パフォーマンス

#### 5.2.1 フロントエンド最適化
- Next.js Server Componentsによる初期ロード高速化
- 画像最適化（next/image）
- コード分割（自動）
- Vercel CDNによる静的アセットキャッシング

#### 5.2.2 データベース最適化
- 主キー・外部キーへの自動インデックス
- 頻繁に検索されるカラムへのインデックス（group_id, user_id等）
- 必要なデータのみを取得するクエリ設計

#### 5.2.3 PWA対応
- Service Workerによるキャッシング
- オフライン時のエラーメッセージ表示
- アプリライクな操作感（standalone表示モード）
